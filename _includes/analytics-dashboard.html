<!-- 分析ダッシュボード（管理者用） -->
<div id="analyticsDashboard" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000;">
  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0; color: #333;">A/Bテスト分析ダッシュボード</h2>
      <button onclick="closeAnalyticsDashboard()" style="background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">×</button>
    </div>
    
    <div id="dashboardContent">
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333; margin-bottom: 10px;">現在のA/Bテスト状況</h3>
        <div id="currentTests" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
          <!-- テスト状況がここに表示される -->
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333; margin-bottom: 10px;">イベント統計</h3>
        <div id="eventStats" style="background: #f5f5f5; padding: 15px; border-radius: 4px;">
          <!-- イベント統計がここに表示される -->
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333; margin-bottom: 10px;">最近のイベント</h3>
        <div id="recentEvents" style="max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 4px;">
          <!-- 最近のイベントがここに表示される -->
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="exportData()" style="background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">データエクスポート</button>
        <button onclick="clearData()" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">データクリア</button>
      </div>
    </div>
  </div>
</div>

<script>
// 分析ダッシュボード機能
function openAnalyticsDashboard() {
  const dashboard = document.getElementById('analyticsDashboard');
  if (dashboard) {
    updateDashboardContent();
    dashboard.style.display = 'block';
  }
}

function closeAnalyticsDashboard() {
  const dashboard = document.getElementById('analyticsDashboard');
  if (dashboard) {
    dashboard.style.display = 'none';
  }
}

function updateDashboardContent() {
  if (!window.abTestManager) return;
  
  // 現在のテスト状況
  updateCurrentTests();
  
  // イベント統計
  updateEventStats();
  
  // 最近のイベント
  updateRecentEvents();
}

function updateCurrentTests() {
  const container = document.getElementById('currentTests');
  if (!container || !window.abTestManager) return;
  
  const tests = window.abTestManager.tests;
  const userVariants = window.abTestManager.userVariants;
  
  container.innerHTML = '';
  
  Object.keys(tests).forEach(testName => {
    const test = tests[testName];
    const userVariant = userVariants[testName] || 'A';
    
    const testCard = document.createElement('div');
    testCard.style.cssText = 'background: white; border: 1px solid #ddd; padding: 15px; border-radius: 4px;';
    
    testCard.innerHTML = `
      <h4 style="margin: 0 0 10px 0; color: #333;">${testName.replace('_', ' ').toUpperCase()}</h4>
      <p style="margin: 5px 0; font-size: 14px;"><strong>ステータス:</strong> ${test.active ? '実行中' : '停止中'}</p>
      <p style="margin: 5px 0; font-size: 14px;"><strong>あなたのバリアント:</strong> ${userVariant}</p>
      <p style="margin: 5px 0; font-size: 14px;"><strong>バリアント:</strong> ${test.variants.join(', ')}</p>
      <div style="margin-top: 10px;">
        ${test.variants.map(variant => 
          `<span style="display: inline-block; margin: 2px; padding: 2px 6px; background: ${variant === userVariant ? '#007cba' : '#eee'}; color: ${variant === userVariant ? 'white' : '#333'}; border-radius: 2px; font-size: 12px;">${variant}</span>`
        ).join('')}
      </div>
    `;
    
    container.appendChild(testCard);
  });
}

function updateEventStats() {
  const container = document.getElementById('eventStats');
  if (!container || !window.abTestManager) return;
  
  const stats = window.abTestManager.getStats();
  
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
  
  Object.keys(stats).forEach(eventName => {
    const eventStat = stats[eventName];
    html += `
      <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #ddd;">
        <h5 style="margin: 0 0 8px 0; color: #333;">${eventName.replace('_', ' ')}</h5>
        <p style="margin: 0; font-size: 18px; font-weight: bold; color: #007cba;">${eventStat.total}</p>
        <div style="margin-top: 8px; font-size: 12px;">
          ${Object.keys(eventStat.variants).map(variant => 
            `<div>${variant}: ${eventStat.variants[variant]}</div>`
          ).join('')}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function updateRecentEvents() {
  const container = document.getElementById('recentEvents');
  if (!container) return;
  
  const events = JSON.parse(localStorage.getItem('ab_test_events') || '[]');
  const recentEvents = events.slice(-20).reverse(); // 最新20件を逆順で
  
  if (recentEvents.length === 0) {
    container.innerHTML = '<p style="margin: 0; color: #666;">イベントがありません</p>';
    return;
  }
  
  const html = recentEvents.map(event => {
    const time = new Date(event.data.timestamp).toLocaleString('ja-JP');
    return `
      <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #007cba;">
        <div style="font-weight: bold; font-size: 14px;">${event.event}</div>
        <div style="font-size: 12px; color: #666; margin-top: 2px;">${time}</div>
        <div style="font-size: 12px; color: #333; margin-top: 2px;">
          ${Object.keys(event.data).filter(key => key.includes('variant')).map(key => 
            `${key}: ${event.data[key]}`
          ).join(', ')}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function exportData() {
  const events = JSON.parse(localStorage.getItem('ab_test_events') || '[]');
  const variants = JSON.parse(localStorage.getItem('ab_test_variants') || '{}');
  
  const data = {
    events: events,
    variants: variants,
    exportTime: new Date().toISOString(),
    userAgent: navigator.userAgent
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `ab_test_data_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  URL.revokeObjectURL(url);
  
  alert('データをエクスポートしました');
}

function clearData() {
  if (confirm('すべてのA/Bテストデータを削除しますか？この操作は取り消せません。')) {
    localStorage.removeItem('ab_test_events');
    localStorage.removeItem('ab_test_variants');
    localStorage.removeItem('ab_test_user_id');
    
    alert('データを削除しました。ページを再読み込みしてください。');
    location.reload();
  }
}

// 管理者用ショートカット（Ctrl+Shift+A）
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.shiftKey && e.key === 'A') {
    e.preventDefault();
    openAnalyticsDashboard();
  }
});

// 管理者用ボタン（開発時のみ表示）
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.createElement('button');
    button.textContent = '📊 Analytics';
    button.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #007cba;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 9999;
      font-size: 12px;
    `;
    button.onclick = openAnalyticsDashboard;
    document.body.appendChild(button);
  });
}
</script>

<style>
/* ダッシュボード用スタイル */
#analyticsDashboard * {
  box-sizing: border-box;
}

#analyticsDashboard h2,
#analyticsDashboard h3,
#analyticsDashboard h4,
#analyticsDashboard h5 {
  font-family: 'Noto Sans JP', sans-serif;
}

#analyticsDashboard button:hover {
  opacity: 0.8;
}

#analyticsDashboard button:active {
  transform: translateY(1px);
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
  #analyticsDashboard > div {
    max-width: 95vw !important;
    max-height: 90vh !important;
    padding: 15px !important;
  }
  
  #currentTests {
    grid-template-columns: 1fr !important;
  }
}
</style>

