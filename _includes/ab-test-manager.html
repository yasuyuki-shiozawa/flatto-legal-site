<!-- A/Bテスト管理システム -->
<script>
// A/Bテスト管理システム
class ABTestManager {
  constructor() {
    this.tests = {
      'floating_cta': {
        variants: ['A', 'B', 'C'],
        weights: [33.3, 33.3, 33.3],
        active: true
      },
      'search_placement': {
        variants: ['A', 'B', 'C'],
        weights: [33.3, 33.3, 33.3],
        active: true
      },
      'video_cta_timing': {
        variants: ['A', 'B', 'C'],
        weights: [33.3, 33.3, 33.3],
        active: true
      }
    };
    
    this.userVariants = this.loadUserVariants();
    this.initializeTests();
  }

  // ユーザーIDの生成・取得
  getUserId() {
    let userId = localStorage.getItem('ab_test_user_id');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      localStorage.setItem('ab_test_user_id', userId);
    }
    return userId;
  }

  // ハッシュ関数
  hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // 32bit整数に変換
    }
    return hash;
  }

  // バリアント決定
  getVariant(testName) {
    if (!this.tests[testName] || !this.tests[testName].active) {
      return 'A'; // デフォルト
    }

    // 既に決定済みの場合は同じバリアントを返す
    if (this.userVariants[testName]) {
      return this.userVariants[testName];
    }

    const userId = this.getUserId();
    const hash = this.hashCode(userId + testName);
    const variants = this.tests[testName].variants;
    const variant = variants[Math.abs(hash) % variants.length];
    
    // バリアントを保存
    this.userVariants[testName] = variant;
    this.saveUserVariants();
    
    return variant;
  }

  // ユーザーバリアントの読み込み
  loadUserVariants() {
    const saved = localStorage.getItem('ab_test_variants');
    return saved ? JSON.parse(saved) : {};
  }

  // ユーザーバリアントの保存
  saveUserVariants() {
    localStorage.setItem('ab_test_variants', JSON.stringify(this.userVariants));
  }

  // イベント追跡
  trackEvent(eventName, properties = {}) {
    const eventData = {
      ...properties,
      user_id: this.getUserId(),
      timestamp: new Date().toISOString(),
      page_url: window.location.href,
      user_agent: navigator.userAgent
    };

    // Google Analytics 4に送信
    if (typeof gtag !== 'undefined') {
      gtag('event', eventName, eventData);
    }

    // カスタム分析システムに送信
    this.sendToCustomAnalytics(eventName, eventData);
  }

  // カスタム分析システムへの送信
  sendToCustomAnalytics(eventName, eventData) {
    // 将来的にカスタム分析システムを実装する場合
    console.log('AB Test Event:', eventName, eventData);
    
    // ローカルストレージに保存（デモ用）
    const events = JSON.parse(localStorage.getItem('ab_test_events') || '[]');
    events.push({ event: eventName, data: eventData });
    
    // 最新1000件のみ保持
    if (events.length > 1000) {
      events.splice(0, events.length - 1000);
    }
    
    localStorage.setItem('ab_test_events', JSON.stringify(events));
  }

  // テスト初期化
  initializeTests() {
    // フローティングCTAテスト
    this.initializeFloatingCTATest();
    
    // 検索機能テスト
    this.initializeSearchTest();
    
    // 動画CTAテスト
    this.initializeVideoCTATest();
  }

  // フローティングCTAテスト初期化
  initializeFloatingCTATest() {
    const variant = this.getVariant('floating_cta');
    const ctaElement = document.getElementById('floatingCTAEnhanced');
    
    if (ctaElement) {
      const messageElement = ctaElement.querySelector('.cta-message');
      if (messageElement) {
        switch (variant) {
          case 'A':
            messageElement.innerHTML = '申請期限が迫っています！<br>今すぐ専門家にご相談ください';
            break;
          case 'B':
            messageElement.innerHTML = '無料相談で成功率99.8%！<br>最短7日で申請完了';
            break;
          case 'C':
            messageElement.innerHTML = '⚠️ 申請締切まであと30日！<br>今すぐ無料相談';
            break;
        }
      }

      // クリックイベント追跡
      ctaElement.addEventListener('click', (e) => {
        if (e.target.closest('a')) {
          this.trackEvent('floating_cta_click', {
            'event_category': 'CTA',
            'event_label': 'floating_cta',
            'cta_variant': variant,
            'button_type': e.target.textContent.includes('電話') ? 'phone' : 'form'
          });
        }
      });
    }
  }

  // 検索機能テスト初期化
  initializeSearchTest() {
    const variant = this.getVariant('search_placement');
    const searchButton = document.querySelector('a[href*="search"]');
    
    if (searchButton) {
      switch (variant) {
        case 'A':
          searchButton.textContent = '検索';
          break;
        case 'B':
          searchButton.innerHTML = '🔍 検索';
          break;
        case 'C':
          searchButton.innerHTML = '🔍 サイト内検索';
          searchButton.style.fontSize = '16px';
          searchButton.style.padding = '8px 16px';
          break;
      }

      // クリックイベント追跡
      searchButton.addEventListener('click', () => {
        this.trackEvent('search_button_click', {
          'event_category': 'Search',
          'event_label': 'search_button',
          'search_variant': variant
        });
      });
    }
  }

  // 動画CTAテスト初期化
  initializeVideoCTATest() {
    const variant = this.getVariant('video_cta_timing');
    const videoCTAs = document.querySelectorAll('a[href*="video"], a[href*="動画"]');
    
    videoCTAs.forEach(cta => {
      let displayDelay = 0;
      
      switch (variant) {
        case 'A':
          displayDelay = 0; // 即座に表示
          break;
        case 'B':
          displayDelay = 3000; // 3秒後
          cta.style.display = 'none';
          break;
        case 'C':
          displayDelay = 0; // スクロール連動
          cta.style.display = 'none';
          this.setupScrollTrigger(cta);
          break;
      }

      if (variant === 'B') {
        setTimeout(() => {
          cta.style.display = '';
          cta.style.animation = 'fadeIn 0.5s ease-in';
        }, displayDelay);
      }

      // クリックイベント追跡
      cta.addEventListener('click', () => {
        this.trackEvent('video_cta_click', {
          'event_category': 'Video',
          'event_label': 'video_cta',
          'cta_variant': variant,
          'display_timing': variant === 'A' ? 'immediate' : variant === 'B' ? 'delayed' : 'scroll'
        });
      });
    });
  }

  // スクロールトリガー設定
  setupScrollTrigger(element) {
    let triggered = false;
    
    const checkScroll = () => {
      if (triggered) return;
      
      const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
      
      if (scrollPercent >= 50) {
        element.style.display = '';
        element.style.animation = 'slideInUp 0.5s ease-out';
        triggered = true;
        window.removeEventListener('scroll', checkScroll);
      }
    };
    
    window.addEventListener('scroll', checkScroll);
  }

  // 統計情報取得
  getStats() {
    const events = JSON.parse(localStorage.getItem('ab_test_events') || '[]');
    const stats = {};
    
    events.forEach(event => {
      const key = event.event;
      if (!stats[key]) {
        stats[key] = { total: 0, variants: {} };
      }
      stats[key].total++;
      
      // バリアント別統計
      Object.keys(this.tests).forEach(testName => {
        const variantKey = testName.replace('_', '_variant');
        if (event.data[variantKey]) {
          const variant = event.data[variantKey];
          if (!stats[key].variants[variant]) {
            stats[key].variants[variant] = 0;
          }
          stats[key].variants[variant]++;
        }
      });
    });
    
    return stats;
  }
}

// グローバルインスタンス作成
window.abTestManager = new ABTestManager();

// ページ読み込み完了時の追跡
document.addEventListener('DOMContentLoaded', () => {
  window.abTestManager.trackEvent('page_view', {
    'event_category': 'Engagement',
    'event_label': 'page_load',
    'page_title': document.title
  });
});

// スクロール深度追跡
let maxScroll = 0;
window.addEventListener('scroll', () => {
  const scrollPercent = Math.round(
    (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100
  );
  
  if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
    maxScroll = scrollPercent;
    window.abTestManager.trackEvent('scroll_depth', {
      'event_category': 'Engagement',
      'event_label': `${scrollPercent}%`,
      'scroll_depth': scrollPercent
    });
  }
});

// 滞在時間追跡
let startTime = Date.now();
window.addEventListener('beforeunload', () => {
  const timeSpent = Math.round((Date.now() - startTime) / 1000);
  window.abTestManager.trackEvent('time_on_page', {
    'event_category': 'Engagement',
    'event_label': 'time_spent',
    'value': timeSpent
  });
});

// CSS アニメーション
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
document.head.appendChild(style);
</script>

