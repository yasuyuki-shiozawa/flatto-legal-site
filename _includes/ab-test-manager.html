<!-- A/Bãƒ†ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  -->
<script>
// A/Bãƒ†ã‚¹ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
class ABTestManager {
  constructor() {
    this.tests = {
      'floating_cta': {
        variants: ['A', 'B', 'C'],
        weights: [33.3, 33.3, 33.3],
        active: true
      },
      'search_placement': {
        variants: ['A', 'B', 'C'],
        weights: [33.3, 33.3, 33.3],
        active: true
      },
      'video_cta_timing': {
        variants: ['A', 'B', 'C'],
        weights: [33.3, 33.3, 33.3],
        active: true
      }
    };
    
    this.userVariants = this.loadUserVariants();
    this.initializeTests();
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®ç”Ÿæˆãƒ»å–å¾—
  getUserId() {
    let userId = localStorage.getItem('ab_test_user_id');
    if (!userId) {
      userId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
      localStorage.setItem('ab_test_user_id', userId);
    }
    return userId;
  }

  // ãƒãƒƒã‚·ãƒ¥é–¢æ•°
  hashCode(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›
    }
    return hash;
  }

  // ãƒãƒªã‚¢ãƒ³ãƒˆæ±ºå®š
  getVariant(testName) {
    if (!this.tests[testName] || !this.tests[testName].active) {
      return 'A'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }

    // æ—¢ã«æ±ºå®šæ¸ˆã¿ã®å ´åˆã¯åŒã˜ãƒãƒªã‚¢ãƒ³ãƒˆã‚’è¿”ã™
    if (this.userVariants[testName]) {
      return this.userVariants[testName];
    }

    const userId = this.getUserId();
    const hash = this.hashCode(userId + testName);
    const variants = this.tests[testName].variants;
    const variant = variants[Math.abs(hash) % variants.length];
    
    // ãƒãƒªã‚¢ãƒ³ãƒˆã‚’ä¿å­˜
    this.userVariants[testName] = variant;
    this.saveUserVariants();
    
    return variant;
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒªã‚¢ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿
  loadUserVariants() {
    const saved = localStorage.getItem('ab_test_variants');
    return saved ? JSON.parse(saved) : {};
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒªã‚¢ãƒ³ãƒˆã®ä¿å­˜
  saveUserVariants() {
    localStorage.setItem('ab_test_variants', JSON.stringify(this.userVariants));
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆè¿½è·¡
  trackEvent(eventName, properties = {}) {
    const eventData = {
      ...properties,
      user_id: this.getUserId(),
      timestamp: new Date().toISOString(),
      page_url: window.location.href,
      user_agent: navigator.userAgent
    };

    // Google Analytics 4ã«é€ä¿¡
    if (typeof gtag !== 'undefined') {
      gtag('event', eventName, eventData);
    }

    // ã‚«ã‚¹ã‚¿ãƒ åˆ†æã‚·ã‚¹ãƒ†ãƒ ã«é€ä¿¡
    this.sendToCustomAnalytics(eventName, eventData);
  }

  // ã‚«ã‚¹ã‚¿ãƒ åˆ†æã‚·ã‚¹ãƒ†ãƒ ã¸ã®é€ä¿¡
  sendToCustomAnalytics(eventName, eventData) {
    // å°†æ¥çš„ã«ã‚«ã‚¹ã‚¿ãƒ åˆ†æã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã™ã‚‹å ´åˆ
    console.log('AB Test Event:', eventName, eventData);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
    const events = JSON.parse(localStorage.getItem('ab_test_events') || '[]');
    events.push({ event: eventName, data: eventData });
    
    // æœ€æ–°1000ä»¶ã®ã¿ä¿æŒ
    if (events.length > 1000) {
      events.splice(0, events.length - 1000);
    }
    
    localStorage.setItem('ab_test_events', JSON.stringify(events));
  }

  // ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–
  initializeTests() {
    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°CTAãƒ†ã‚¹ãƒˆ
    this.initializeFloatingCTATest();
    
    // æ¤œç´¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
    this.initializeSearchTest();
    
    // å‹•ç”»CTAãƒ†ã‚¹ãƒˆ
    this.initializeVideoCTATest();
  }

  // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°CTAãƒ†ã‚¹ãƒˆåˆæœŸåŒ–
  initializeFloatingCTATest() {
    const variant = this.getVariant('floating_cta');
    const ctaElement = document.getElementById('floatingCTAEnhanced');
    
    if (ctaElement) {
      const messageElement = ctaElement.querySelector('.cta-message');
      if (messageElement) {
        switch (variant) {
          case 'A':
            messageElement.innerHTML = 'ç”³è«‹æœŸé™ãŒè¿«ã£ã¦ã„ã¾ã™ï¼<br>ä»Šã™ãå°‚é–€å®¶ã«ã”ç›¸è«‡ãã ã•ã„';
            break;
          case 'B':
            messageElement.innerHTML = 'ç„¡æ–™ç›¸è«‡ã§æˆåŠŸç‡99.8%ï¼<br>æœ€çŸ­7æ—¥ã§ç”³è«‹å®Œäº†';
            break;
          case 'C':
            messageElement.innerHTML = 'âš ï¸ ç”³è«‹ç· åˆ‡ã¾ã§ã‚ã¨30æ—¥ï¼<br>ä»Šã™ãç„¡æ–™ç›¸è«‡';
            break;
        }
      }

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½è·¡
      ctaElement.addEventListener('click', (e) => {
        if (e.target.closest('a')) {
          this.trackEvent('floating_cta_click', {
            'event_category': 'CTA',
            'event_label': 'floating_cta',
            'cta_variant': variant,
            'button_type': e.target.textContent.includes('é›»è©±') ? 'phone' : 'form'
          });
        }
      });
    }
  }

  // æ¤œç´¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–
  initializeSearchTest() {
    const variant = this.getVariant('search_placement');
    const searchButton = document.querySelector('a[href*="search"]');
    
    if (searchButton) {
      switch (variant) {
        case 'A':
          searchButton.textContent = 'æ¤œç´¢';
          break;
        case 'B':
          searchButton.innerHTML = 'ğŸ” æ¤œç´¢';
          break;
        case 'C':
          searchButton.innerHTML = 'ğŸ” ã‚µã‚¤ãƒˆå†…æ¤œç´¢';
          searchButton.style.fontSize = '16px';
          searchButton.style.padding = '8px 16px';
          break;
      }

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½è·¡
      searchButton.addEventListener('click', () => {
        this.trackEvent('search_button_click', {
          'event_category': 'Search',
          'event_label': 'search_button',
          'search_variant': variant
        });
      });
    }
  }

  // å‹•ç”»CTAãƒ†ã‚¹ãƒˆåˆæœŸåŒ–
  initializeVideoCTATest() {
    const variant = this.getVariant('video_cta_timing');
    const videoCTAs = document.querySelectorAll('a[href*="video"], a[href*="å‹•ç”»"]');
    
    videoCTAs.forEach(cta => {
      let displayDelay = 0;
      
      switch (variant) {
        case 'A':
          displayDelay = 0; // å³åº§ã«è¡¨ç¤º
          break;
        case 'B':
          displayDelay = 3000; // 3ç§’å¾Œ
          cta.style.display = 'none';
          break;
        case 'C':
          displayDelay = 0; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£å‹•
          cta.style.display = 'none';
          this.setupScrollTrigger(cta);
          break;
      }

      if (variant === 'B') {
        setTimeout(() => {
          cta.style.display = '';
          cta.style.animation = 'fadeIn 0.5s ease-in';
        }, displayDelay);
      }

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½è·¡
      cta.addEventListener('click', () => {
        this.trackEvent('video_cta_click', {
          'event_category': 'Video',
          'event_label': 'video_cta',
          'cta_variant': variant,
          'display_timing': variant === 'A' ? 'immediate' : variant === 'B' ? 'delayed' : 'scroll'
        });
      });
    });
  }

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
  setupScrollTrigger(element) {
    let triggered = false;
    
    const checkScroll = () => {
      if (triggered) return;
      
      const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
      
      if (scrollPercent >= 50) {
        element.style.display = '';
        element.style.animation = 'slideInUp 0.5s ease-out';
        triggered = true;
        window.removeEventListener('scroll', checkScroll);
      }
    };
    
    window.addEventListener('scroll', checkScroll);
  }

  // çµ±è¨ˆæƒ…å ±å–å¾—
  getStats() {
    const events = JSON.parse(localStorage.getItem('ab_test_events') || '[]');
    const stats = {};
    
    events.forEach(event => {
      const key = event.event;
      if (!stats[key]) {
        stats[key] = { total: 0, variants: {} };
      }
      stats[key].total++;
      
      // ãƒãƒªã‚¢ãƒ³ãƒˆåˆ¥çµ±è¨ˆ
      Object.keys(this.tests).forEach(testName => {
        const variantKey = testName.replace('_', '_variant');
        if (event.data[variantKey]) {
          const variant = event.data[variantKey];
          if (!stats[key].variants[variant]) {
            stats[key].variants[variant] = 0;
          }
          stats[key].variants[variant]++;
        }
      });
    });
    
    return stats;
  }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
window.abTestManager = new ABTestManager();

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®è¿½è·¡
document.addEventListener('DOMContentLoaded', () => {
  window.abTestManager.trackEvent('page_view', {
    'event_category': 'Engagement',
    'event_label': 'page_load',
    'page_title': document.title
  });
});

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ·±åº¦è¿½è·¡
let maxScroll = 0;
window.addEventListener('scroll', () => {
  const scrollPercent = Math.round(
    (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100
  );
  
  if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
    maxScroll = scrollPercent;
    window.abTestManager.trackEvent('scroll_depth', {
      'event_category': 'Engagement',
      'event_label': `${scrollPercent}%`,
      'scroll_depth': scrollPercent
    });
  }
});

// æ»åœ¨æ™‚é–“è¿½è·¡
let startTime = Date.now();
window.addEventListener('beforeunload', () => {
  const timeSpent = Math.round((Date.now() - startTime) / 1000);
  window.abTestManager.trackEvent('time_on_page', {
    'event_category': 'Engagement',
    'event_label': 'time_spent',
    'value': timeSpent
  });
});

// CSS ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
`;
document.head.appendChild(style);
</script>

