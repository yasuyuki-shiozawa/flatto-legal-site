<!-- æ—¥æœ¬èªåå‰æ¤œè¨¼æ©Ÿèƒ½ -->
<script>
// æ—¥æœ¬èªåå‰æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ 
class JapaneseNameValidator {
    constructor() {
        this.init();
    }

    init() {
        // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.setupValidation());
        } else {
            this.setupValidation();
        }
    }

    setupValidation() {
        // åå‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—
        const nameInputs = document.querySelectorAll('input[type="text"]');
        
        nameInputs.forEach(input => {
            // ãƒ©ãƒ™ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã§åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç‰¹å®š
            const label = this.findLabelForInput(input);
            if (label && (label.textContent.includes('åå‰') || label.textContent.includes('ãŠåå‰'))) {
                this.attachValidationToInput(input);
            }
        });
    }

    findLabelForInput(input) {
        // ç›´å‰ã®labelè¦ç´ ã‚’æ¢ã™
        let prevElement = input.previousElementSibling;
        while (prevElement) {
            if (prevElement.tagName === 'LABEL') {
                return prevElement;
            }
            prevElement = prevElement.previousElementSibling;
        }
        
        // forå±æ€§ã§ãƒªãƒ³ã‚¯ã•ã‚ŒãŸlabelã‚’æ¢ã™
        if (input.id) {
            return document.querySelector(`label[for="${input.id}"]`);
        }
        
        return null;
    }

    attachValidationToInput(input) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
        const errorDiv = document.createElement('div');
        errorDiv.className = 'japanese-name-error';
        errorDiv.style.cssText = `
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: none;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 8px 12px;
        `;
        
        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¾Œã«æŒ¿å…¥
        input.parentNode.insertBefore(errorDiv, input.nextSibling);

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
        const successDiv = document.createElement('div');
        successDiv.className = 'japanese-name-success';
        successDiv.style.cssText = `
            color: #155724;
            font-size: 14px;
            margin-top: 5px;
            display: none;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 8px 12px;
        `;
        successDiv.innerHTML = 'âœ“ æ­£ã—ã„æ—¥æœ¬èªã®ãŠåå‰ã§ã™';
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¾Œã«æŒ¿å…¥
        errorDiv.parentNode.insertBefore(successDiv, errorDiv.nextSibling);

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
        input.addEventListener('input', (e) => {
            this.validateJapaneseName(e.target, errorDiv, successDiv);
        });

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®èª¬æ˜è¡¨ç¤º
        input.addEventListener('focus', () => {
            this.showInputGuide(input, errorDiv);
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®æ¤œè¨¼
        const form = input.closest('form');
        if (form) {
            form.addEventListener('submit', (e) => {
                if (!this.validateJapaneseName(input, errorDiv, successDiv)) {
                    e.preventDefault();
                    input.focus();
                }
            });
        }
    }

    validateJapaneseName(input, errorDiv, successDiv) {
        const value = input.value.trim();
        
        // ç©ºã®å ´åˆ
        if (!value) {
            this.hideMessages(errorDiv, successDiv);
            return false;
        }

        // æ—¥æœ¬èªæ–‡å­—ã®æ­£è¦è¡¨ç¾
        // ã²ã‚‰ãŒãª: \u3040-\u309F
        // ã‚«ã‚¿ã‚«ãƒŠ: \u30A0-\u30FF
        // æ¼¢å­—: \u4E00-\u9FAF
        // å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹: \u3000
        const japaneseRegex = /^[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3000\s]+$/;
        
        // æœ€ä½é™ã®æ—¥æœ¬èªæ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(value);
        
        if (!hasJapanese) {
            this.showError(errorDiv, successDiv, 
                'ãŠåå‰ã¯æ—¥æœ¬èªï¼ˆã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ï¼‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>' +
                'ä¾‹: ç”°ä¸­å¤ªéƒã€ãŸãªã‹ ãŸã‚ã†ã€ã‚¿ãƒŠã‚« ã‚¿ãƒ­ã‚¦'
            );
            input.style.borderColor = '#dc3545';
            return false;
        }

        if (!japaneseRegex.test(value)) {
            this.showError(errorDiv, successDiv, 
                'ãŠåå‰ã«ä½¿ç”¨ã§ããªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚<br>' +
                'æ—¥æœ¬èªï¼ˆã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—ï¼‰ã®ã¿ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚'
            );
            input.style.borderColor = '#dc3545';
            return false;
        }

        // é•·ã•ãƒã‚§ãƒƒã‚¯ï¼ˆ1æ–‡å­—ä»¥ä¸Š50æ–‡å­—ä»¥ä¸‹ï¼‰
        if (value.length < 1 || value.length > 50) {
            this.showError(errorDiv, successDiv, 
                'ãŠåå‰ã¯1æ–‡å­—ä»¥ä¸Š50æ–‡å­—ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'
            );
            input.style.borderColor = '#dc3545';
            return false;
        }

        // æ¤œè¨¼æˆåŠŸ
        this.showSuccess(errorDiv, successDiv);
        input.style.borderColor = '#28a745';
        return true;
    }

    showError(errorDiv, successDiv, message) {
        errorDiv.innerHTML = message;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
    }

    showSuccess(errorDiv, successDiv) {
        errorDiv.style.display = 'none';
        successDiv.style.display = 'block';
    }

    hideMessages(errorDiv, successDiv) {
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
    }

    showInputGuide(input, errorDiv) {
        if (!input.value.trim()) {
            errorDiv.innerHTML = 
                'ğŸ’¡ <strong>å…¥åŠ›ã®ãƒ’ãƒ³ãƒˆ:</strong><br>' +
                'â€¢ ã²ã‚‰ãŒãª: ãŸãªã‹ ãŸã‚ã†<br>' +
                'â€¢ ã‚«ã‚¿ã‚«ãƒŠ: ã‚¿ãƒŠã‚« ã‚¿ãƒ­ã‚¦<br>' +
                'â€¢ æ¼¢å­—: ç”°ä¸­å¤ªéƒ<br>' +
                'â€¢ çµ„ã¿åˆã‚ã›: ç”°ä¸­ ãŸã‚ã†';
            errorDiv.style.cssText = errorDiv.style.cssText.replace('color: #dc3545', 'color: #6c757d');
            errorDiv.style.cssText = errorDiv.style.cssText.replace('background: #f8d7da', 'background: #f8f9fa');
            errorDiv.style.cssText = errorDiv.style.cssText.replace('border: 1px solid #f5c6cb', 'border: 1px solid #dee2e6');
            errorDiv.style.display = 'block';
        }
    }
}

// åˆæœŸåŒ–
new JapaneseNameValidator();
</script>

<style>
/* æ—¥æœ¬èªåå‰æ¤œè¨¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.japanese-name-error,
.japanese-name-success {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã‚¹ã‚¿ã‚¤ãƒ« */
input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    transition: box-shadow 0.15s ease-in-out;
}

/* ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
input[style*="border-color: #dc3545"] {
    box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25) !important;
}

/* æˆåŠŸæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
input[style*="border-color: #28a745"] {
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25) !important;
}
</style>

